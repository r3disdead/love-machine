<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LOVE MACHINE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
        background:#000;color:#fff;font-family:'Comic Sans MS',cursive;
        min-height:100vh;
        height:100vh;
        display:flex;
        flex-direction:column;
        overflow-y:auto;               /* ← FIX in-app : permet le scroll */
        touch-action:manipulation;
        user-select:none;
        -webkit-overflow-scrolling:touch; /* ← iOS scroll fluide */
    }
    h1{
        position:fixed;top:0;left:0;right:0;z-index:1000;
        text-align:center;padding:12px 0;background:rgba(0,0,0,0.9);
        font-size:clamp(40px,12vw,100px);color:#ff1493;
        text-shadow:0 0 50px #ff1493,0 0 100px #ff69b4;letter-spacing:10px;
        pointer-events:none;
    }
    #game-container{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;gap:12px;}
    #game-frame{
        width:100%;max-width:900px;aspect-ratio:800/632;
        border:16px solid #ff1493;border-radius:36px;
        overflow:hidden;
        box-shadow:0 0 120px #ff1493,inset 0 0 90px rgba(255,20,147,0.8);
        background:#000;position:relative;
    }
    @media (max-width:600px){
        #game-frame{max-width:500px;border:14px solid #ff1493;border-radius:32px;}
    }
    #game{width:100%;height:100%;position:relative;overflow:hidden;}
    #scene-svg,#character-svg{
        position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;
    }
    #character-svg{z-index:10;}
    #instructions{
        padding:12px 18px;background:rgba(0,0,0,0.7);border-radius:14px;
        font-size:clamp(16px,4.8vw,24px);color:#ff69b4;text-align:center;
        text-shadow:0 0 18px #ff1493;opacity:0;transition:opacity 1s;
    }
    #instructions.visible{opacity:1;}
    #input-zone{
        padding:14px;background:rgba(0,0,0,0.95);text-align:center;
        border-top:4px solid #ff1493;
        flex-shrink:0;                 /* ← ne se fait jamais écraser */
        min-height:130px;              /* ← toujours visible même sur in-app */
        padding-bottom:max(env(safe-area-inset-bottom), 20px);
    }
    input{
        width:100%;max-width:420px;padding:14px;background:#111;
        border:3px solid #ff1493;border-radius:12px;color:#ff69b4;
        text-align:center;font-size:17px;
    }
    button{
        margin-top:10px;padding:12px 32px;background:#ff1493;color:#000;
        border:none;border-radius:12px;font-weight:bold;font-size:17px;cursor:pointer;
    }
    .heart-fly{
        position:fixed;pointer-events:none;z-index:9999;
        font-size:72px;color:#ff1493;text-shadow:0 0 45px #ff69b4;
        animation:cosmicFly 2.2s ease-out forwards;
    }
    .heart-permanent{
        position:fixed;pointer-events:none;z-index:9998;
        font-size:64px;color:#ff1493;
        text-shadow:0 0 40px #ff69b4,0 0 80px #ff1493;
        animation:pulse 3s infinite alternate;opacity:0.9;
    }
    @keyframes cosmicFly{
        0%{transform:scale(0.8) rotate(0deg);opacity:1;}
        50%{transform:scale(1.5) rotate(720deg);opacity:1;}
        100%{transform:translate(var(--dx),var(--dy)) rotate(1080deg) scale(0.4);opacity:0.5;}
    }
    @keyframes pulse{
        from{transform:scale(1);text-shadow:0 0 40px #ff69b4,0 0 80px #ff1493;}
        to{transform:scale(1.3);text-shadow:0 0 70px #ff69b4,0 0 140px #ff1493;}
    }
</style>
</head>
<body>

<h1>LOVE MACHINE</h1>

<div id="game-container">
    <div id="instructions"></div>
    <div id="game-frame">
        <div id="game">
            <svg id="scene-svg" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet"></svg>
            <svg id="character-svg" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
    </div>
</div>

<div id="input-zone">
    <label>Your lovely inscription ID</label>
    <input type="text" id="inscriptionId" placeholder="paste love_message ID + press Enter">
    <button onclick="loadInscription()">LOAD LOVE</button>
</div>

<script>
    const game = document.getElementById('game');
    const charSvg = document.getElementById('character-svg');
    const instructions = document.getElementById('instructions');
    const inputField = document.getElementById('inscriptionId');

    const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    instructions.innerHTML = isMobile ? "" : "← → Move · ↑ Jump · SPACE = SEND LOVE";

    let x = 0, y = 0, vy = 0, jumping = false;
    let lastShot = 0;
    const permanentHearts = [];
    const keys = {};

    function clearHearts(){
        document.querySelectorAll('.heart-fly,.heart-permanent').forEach(h=>h.remove());
        permanentHearts.length = 0;
    }

    async function loadInscription(){
        clearHearts();
        const id = inputField.value.trim();
        if(!id) return;
        try{
            const resp = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://ordinals.com/content/'+id)}`);
            const data = await resp.json();
            let svgText = data.contents.replace(/href="\/content\//g,'href="https://ordinals.com/content/');
            const doc = new DOMParser().parseFromString(svgText,'image/svg+xml');
            const images = doc.querySelectorAll('image');
            if(images.length < 6){ alert("Need 6+ layers!"); return; }

            const sceneHTML = Array.from(images).slice(0,-1).map(i=>`<image href="${i.getAttribute('href')}" width="800" height="600"/>`).join('');
            const charHref = images[images.length-1].getAttribute('href');

            document.getElementById('scene-svg').innerHTML = sceneHTML;
            document.getElementById('character-svg').innerHTML = `
                <defs><mask id="mask"><image href="${charHref}" width="800" height="600" style="filter:brightness(30)"/></mask></defs>
                <image href="${charHref}" width="800" height="600" mask="url(#mask)"/>`;

            instructions.classList.add('visible');
            x = y = 0;
        }catch(e){ alert("Load failed"); console.error(e); }
    }

    function shoot(){
        if(Date.now() - lastShot < 90) return;
        lastShot = Date.now();

        const rect = game.getBoundingClientRect();
        const scaleX = rect.width/800;
        const scaleY = rect.height/600;
        const baseX = rect.left + rect.width/2 + x*scaleX;
        const baseY = rect.top + rect.height*0.9 + y*scaleY;

        const count = 6 + Math.floor(Math.random()*4);

        for(let i=0;i<count;i++){
            const fly = document.createElement('div');
            fly.className='heart-fly';
            fly.textContent='♥';
            fly.style.left=baseX+'px';
            fly.style.top=baseY+'px';
            const dx=(Math.random()-0.5)*2400;
            const dy=(Math.random()-0.5)*1800;
            fly.style.setProperty('--dx',dx+'px');
            fly.style.setProperty('--dy',dy+'px');
            document.body.appendChild(fly);
            setTimeout(()=>fly.remove(),2400);

            if(Math.random()<0.3){
                const perm=document.createElement('div');
                perm.className='heart-permanent';
                perm.textContent='♥';
                perm.style.left=(baseX+dx)+'px';
                perm.style.top=(baseY+dy)+'px';
                document.body.appendChild(perm);
                permanentHearts.push(perm);
            }
        }

        permanentHearts.forEach(p=>{
            const mini=document.createElement('div');
            mini.className='heart-fly';
            mini.textContent='♥';
            mini.style.fontSize='48px';
            mini.style.left=p.style.left;
            mini.style.top=p.style.top;
            const mx=(Math.random()-0.5)*1200;
            const my=(Math.random()-0.5)*1000;
            mini.style.setProperty('--dx',mx+'px');
            mini.style.setProperty('--dy',my+'px');
            document.body.appendChild(mini);
            setTimeout(()=>mini.remove(),2400);
        });
    }

    function loop(){
        if(keys.ArrowLeft || keys.KeyA) x -= 18;
        if(keys.ArrowRight || keys.KeyD) x += 18;
        x = Math.max(-700, Math.min(700, x));

        if(jumping){
            y += vy;
            vy += 1.4;
            if(y >= 0){ y = 0; jumping = false; vy = 0; }
        }

        if(keys.Space) shoot();

        charSvg.style.transform = `translate(${x}px,${Math.max(y,-180)}px)`;
        requestAnimationFrame(loop);
    }

    // Touch mobile
    let touchId=null, touchStartX=0, lastTap=0, longPressTimer=null;
    game.addEventListener('touchstart',e=>{
        e.preventDefault();
        for(const t of e.changedTouches){
            if(touchId!==null) continue;
            touchId=t.identifier;
            touchStartX=t.clientX;
            const now=Date.now();
            if(now-lastTap<320){ if(!jumping){ jumping=true; vy=-22; }}
            lastTap=now;
            clearTimeout(longPressTimer);
            longPressTimer=setTimeout(()=>{shoot();},500);
        }
    },{passive:false});

    game.addEventListener('touchmove',e=>{
        e.preventDefault();
        for(const t of e.changedTouches){
            if(t.identifier!==touchId) continue;
            const delta=t.clientX-touchStartX;
            x += delta/4;
            touchStartX = t.clientX;
            x = Math.max(-700, Math.min(700, x));
        }
    },{passive:false});

    game.addEventListener('touchend',()=>{ if(touchId!==null){ touchId=null; clearTimeout(longPressTimer); }});

    // Clavier
    window.addEventListener('keydown', e => {
        if(!keys[e.code]){
            keys[e.code] = true;
            if(e.code === 'ArrowUp' && !jumping){ jumping = true; vy = -22; }
            if(e.code === 'Space'){ e.preventDefault(); shoot(); }
        }
    });

    window.addEventListener('keyup', e => {
        keys[e.code] = false;
    });

    inputField.addEventListener('keypress', e => { if(e.key==='Enter') loadInscription(); });

    // FIX FINAL in-app browser (X/Twitter, etc.)
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.body.style.overflowY = 'auto';
            window.scrollTo(0, 1); // force l'affichage complet sur certains in-app
        }, 300);
    });

    requestAnimationFrame(loop);
</script>
</body>
</html>
